name: CI

on:
  pull_request:
    branches:
      - '**'
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  # ============================================================================
  # REQUIRED: Lockfile is stable under npm ci
  # ============================================================================
  lockfile:
    name: Lockfile Stable
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Verify lockfile unchanged
        run: git diff --exit-code package-lock.json

  # ============================================================================
  # REQUIRED: Build Artifact (single source of truth for dist/)
  # ============================================================================
  build-artifact:
    name: Build Artifact (dist/)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Build dist/
        run: npm run build

      - name: Verify dist artifacts
        run: |
          test -f dist/index.js || (echo "Missing dist/index.js" && exit 1)
          echo "Build artifacts verified."

      - name: Upload dist artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: dist
          path: dist/
          if-no-files-found: error

  # ============================================================================
  # REQUIRED: Type Check
  # ============================================================================
  typecheck:
    name: Type Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Type check
        run: npm run typecheck

  # ============================================================================
  # REQUIRED (PR only): semantic-release dry-run
  # ============================================================================
  semantic-release-dry-run:
    name: semantic-release dry-run
    runs-on: ubuntu-latest
    needs: [lockfile, build-artifact]
    if: github.event_name == 'pull_request'
    permissions:
      contents: read

    steps:
      - name: Checkout code (full history)
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: semantic-release dry-run
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npx semantic-release --dry-run --no-ci --verify-conditions false

  # ============================================================================
  # INFORMATIONAL: Security Audit
  # ============================================================================
  security:
    name: Security Audit
    runs-on: ubuntu-latest
    continue-on-error: true

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Run security audit
        run: |
          echo "## Security Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          npm audit --audit-level=high 2>&1 | tee audit-results.txt || true
          if grep -q "found 0 vulnerabilities" audit-results.txt; then
            echo "No high/critical vulnerabilities found." >> $GITHUB_STEP_SUMMARY
          else
            echo "Review audit results above for potential vulnerabilities." >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================================================
  # REQUIRED: Build & Test (cross-platform matrix)
  # ============================================================================
  build-and-test:
    name: Build & Test (${{ matrix.os }}, Node ${{ matrix.node-version }})
    runs-on: ${{ matrix.os }}
    needs: build-artifact
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        node-version: [20, 22]
      fail-fast: false

    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm

      - name: Install dependencies
        run: npm ci --ignore-scripts

      - name: Download build artifact (dist/)
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: dist
          path: dist

      - name: Run tests
        run: npm test

  # ============================================================================
  # GATE: All required checks must pass
  # ============================================================================
  ci-success:
    name: CI Success
    runs-on: ubuntu-latest
    needs: [lockfile, build-artifact, semantic-release-dry-run, typecheck, build-and-test]
    if: always()
    steps:
      - name: Check required jobs
        run: |
          echo "## CI Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check lockfile
          if [[ "${{ needs.lockfile.result }}" != "success" ]]; then
            echo "- Lockfile Stable: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Lockfile job failed"
            exit 1
          fi
          echo "- Lockfile Stable: PASSED" >> $GITHUB_STEP_SUMMARY

          # Check build-artifact
          if [[ "${{ needs.build-artifact.result }}" != "success" ]]; then
            echo "- Build Artifact: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Build Artifact job failed"
            exit 1
          fi
          echo "- Build Artifact: PASSED" >> $GITHUB_STEP_SUMMARY

          # Check semantic-release-dry-run (on PRs only)
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            if [[ "${{ needs.semantic-release-dry-run.result }}" != "success" ]]; then
              echo "- semantic-release dry-run: FAILED" >> $GITHUB_STEP_SUMMARY
              echo "semantic-release dry-run job failed"
              exit 1
            fi
            echo "- semantic-release dry-run: PASSED" >> $GITHUB_STEP_SUMMARY
          fi

          # Check typecheck
          if [[ "${{ needs.typecheck.result }}" != "success" ]]; then
            echo "- Type Check: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Type check failed"
            exit 1
          fi
          echo "- Type Check: PASSED" >> $GITHUB_STEP_SUMMARY

          # Check build-and-test
          if [[ "${{ needs.build-and-test.result }}" != "success" ]]; then
            echo "- Build & Test: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "Build & Test job failed"
            exit 1
          fi
          echo "- Build & Test: PASSED" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All required CI checks passed." >> $GITHUB_STEP_SUMMARY
